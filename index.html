<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS - WiFi Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav button {
            padding: 12px 24px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .nav button:hover {
            background: #0056b3;
        }

        .nav button.active {
            background: #28a745;
        }

        .content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }

        .card.occupied {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .order-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
        }

        .order-card.processing {
            border-left-color: #ffc107;
        }

        .order-card.ready {
            border-left-color: #28a745;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: #6c757d;
            color: white;
        }

        .status-badge.connected {
            background: #28a745;
        }

        .status-badge.syncing {
            background: #ffc107;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Network Status Styles */
        .network-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .network-status.connected {
            background: #28a745;
        }

        .network-status.syncing {
            background: #ffc107;
            color: #333;
        }

        .network-status.error {
            background: #dc3545;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: white;
        }

        .status-dot.pulsing {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* Device List Styles */
        .device-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .device-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #e9ecef;
        }

        .device-item.connected {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .device-ip {
            font-size: 12px;
            color: #666;
        }

        /* Chat Styles */
        .chat-container {
            margin-top: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .chat-message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            max-width: 80%;
        }

        .chat-message.local {
            background: #dbeafe;
            margin-left: auto;
        }

        .chat-message.remote {
            background: #e9ecef;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .quick-messages {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .quick-messages button {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Sync Log */
        .sync-log {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        .log-time {
            color: #666;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .network-status {
                top: 10px;
                right: 10px;
                font-size: 12px;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="network-status" id="networkStatus">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Disconnected</span>
    </div>

    <div class="container">
        <div class="header">
            <h1 style="margin-bottom: 20px;">Restaurant POS - WiFi Sync</h1>
            <div class="nav">
                <button onclick="showSection('tables')" class="active" id="nav-tables">Tables</button>
                <button onclick="showSection('menu')" id="nav-menu">Menu</button>
                <button onclick="showSection('kitchen')" id="nav-kitchen">Kitchen</button>
                <button onclick="showSection('network')" id="nav-network">Network Sync</button>
                <button onclick="showSection('chat')" id="nav-chat">Staff Chat</button>
            </div>
        </div>

        <div class="content">
            <!-- Tables Section -->
            <div id="tables" class="section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Tables</h2>
                    <button class="btn btn-primary" onclick="showAddTableModal()">Add Table</button>
                </div>
                <div id="tablesGrid" class="grid"></div>
            </div>

            <!-- Menu Section -->
            <div id="menu" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Menu Items</h2>
                    <button class="btn btn-primary" onclick="showAddMenuModal()">Add Item</button>
                </div>
                <div id="menuList"></div>
            </div>

            <!-- Kitchen Section -->
            <div id="kitchen" class="section">
                <h2 style="margin-bottom: 20px;">Kitchen Display</h2>
                <div id="kitchenOrders"></div>
            </div>

            <!-- Network Sync Section -->
            <div id="network" class="section">
                <h2 style="margin-bottom: 20px;">WiFi Network Sync</h2>
                
                <div class="form-group">
                    <label>Device Name</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="deviceName" value="POS Terminal" style="flex: 1;">
                        <button class="btn btn-primary" onclick="updateDeviceName()">Update</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Network Status</label>
                    <div id="networkInfo" style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Local IP:</span>
                            <span id="localIp" style="font-weight: bold;">Detecting...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Device ID:</span>
                            <span id="deviceId" style="font-family: monospace; font-size: 14px;">Loading...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Connected Devices:</span>
                            <span id="connectedCount">0</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Connection Mode</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="startBroadcastServer()" id="serverBtn">Start Broadcast Server</button>
                        <button class="btn btn-success" onclick="startAutoDiscovery()" id="discoveryBtn">Discover Devices</button>
                        <button class="btn btn-secondary" onclick="stopAllConnections()">Stop All</button>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        <strong>Broadcast Server:</strong> Acts as central hub for all devices.<br>
                        <strong>Auto Discovery:</strong> Automatically finds and connects to other devices on same WiFi.
                    </small>
                </div>

                <div class="form-group">
                    <label>Connected Devices</label>
                    <div id="devicesList" class="device-list">
                        <p style="color: #666; text-align: center; padding: 20px;">No devices connected</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Sync Controls</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="syncAllData()">Sync All Data</button>
                        <button class="btn btn-success" onclick="syncTablesOnly()">Sync Tables</button>
                        <button class="btn btn-success" onclick="syncMenuOnly()">Sync Menu</button>
                        <button class="btn btn-success" onclick="syncOrdersOnly()">Sync Orders</button>
                        <button class="btn btn-secondary" onclick="forceFullSync()">Force Full Sync</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Sync Log</label>
                    <div id="syncLog" class="sync-log">
                        <!-- Sync logs will appear here -->
                    </div>
                </div>
            </div>

            <!-- Staff Chat Section -->
            <div id="chat" class="section">
                <h2 style="margin-bottom: 20px;">Staff Chat</h2>
                
                <div class="form-group">
                    <label>Connected Staff</label>
                    <div id="staffList" class="device-list">
                        <p style="color: #666; text-align: center; padding: 20px;">No staff connected</p>
                    </div>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <p style="color: #666; text-align: center; padding: 40px 20px;">No messages yet. Connect to other devices to chat.</p>
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="handleChatKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                    </div>

                    <div class="quick-messages">
                        <button class="btn btn-secondary" onclick="sendQuickMessage('Table needs cleaning')">Clean Table</button>
                        <button class="btn btn-secondary" onclick="sendQuickMessage('Order delayed')">Order Delay</button>
                        <button class="btn btn-secondary" onclick="sendQuickMessage('Need assistance')">Assistance</button>
                        <button class="btn btn-secondary" onclick="sendQuickMessage('Order ready for pickup')">Order Ready</button>
                        <button class="btn btn-secondary" onclick="sendQuickMessage('Customer waiting')">Customer Waiting</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Table Modal -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <h2 id="tableModalTitle">Add Table</h2>
            <div class="form-group">
                <label>Table Number</label>
                <input type="text" id="tableNumber" placeholder="e.g., T1, Table 1">
            </div>
            <div class="form-group">
                <label>Capacity</label>
                <input type="number" id="tableCapacity" placeholder="Number of seats">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveTable()">Save</button>
                <button class="btn btn-secondary" onclick="closeModal('tableModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Menu Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <h2 id="menuModalTitle">Add Menu Item</h2>
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="itemName" placeholder="e.g., Burger">
            </div>
            <div class="form-group">
                <label>Category</label>
                <input type="text" id="itemCategory" placeholder="e.g., Main Course">
            </div>
            <div class="form-group">
                <label>Price</label>
                <input type="number" id="itemPrice" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="itemDescription" rows="3" placeholder="Optional description"></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveMenuItem()">Save</button>
                <button class="btn btn-secondary" onclick="closeModal('menuModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <h2 id="orderTableName">Table Order</h2>
            <div style="margin-bottom: 20px;">
                <h3>Menu</h3>
                <div id="orderMenuList"></div>
            </div>
            <div>
                <h3>Current Order</h3>
                <div id="currentOrderList"></div>
                <div style="margin-top: 20px; padding: 20px; background: #e9ecef; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Subtotal:</span>
                        <span id="orderSubtotal">$0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Tax:</span>
                        <span id="orderTax">$0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: bold;">
                        <span>Total:</span>
                        <span id="orderTotal">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="placeOrder()">Place Order</button>
                <button class="btn btn-danger" onclick="checkout()">Checkout</button>
                <button class="btn btn-secondary" onclick="closeModal('orderModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Connection Modal -->
    <div id="connectionModal" class="modal">
        <div class="modal-content">
            <h2>Connect to Device</h2>
            <div class="form-group">
                <label>Server IP Address</label>
                <input type="text" id="serverIp" placeholder="e.g., 192.168.1.100" value="192.168.1.100">
            </div>
            <div class="form-group">
                <label>Port</label>
                <input type="number" id="serverPort" value="8080">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="connectToDevice()">Connect</button>
                <button class="btn btn-secondary" onclick="closeModal('connectionModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CORE POS STATE ====================
        let state = {
            tables: [],
            menu: [],
            orders: [],
            settings: { 
                restaurantName: 'My Restaurant', 
                taxRate: 8.5
            },
            currentTable: null,
            currentOrder: []
        };

        let editingId = null;

        // ==================== NETWORK STATE ====================
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();
        let deviceName = localStorage.getItem('deviceName') || 'POS Terminal';
        let localIp = 'Unknown';
        let isServer = false;
        let wsServer = null;
        let wsClient = null;
        let connectedDevices = new Map();
        let chatMessages = [];
        let syncInterval = null;
        let broadcastInterval = null;
        let peerConnections = new Map();

        // ==================== INITIALIZATION ====================
        function init() {
            // Load POS data
            loadFromLocalStorage();
            
            // Setup device info
            document.getElementById('deviceName').value = deviceName;
            document.getElementById('deviceId').textContent = deviceId;
            
            // Detect network
            detectLocalIP();
            
            // Initialize UI
            renderTables();
            renderMenu();
            renderKitchen();
            updateNetworkStatus();
            
            // Start network discovery
            startNetworkDiscovery();
            
            // Log initialization
            logSync('POS System initialized');
            logSync(`Device: ${deviceName} (${deviceId})`);
        }

        // ==================== LOCAL STORAGE ====================
        function saveToLocalStorage() {
            try {
                localStorage.setItem('pos_state', JSON.stringify(state));
                localStorage.setItem('pos_last_sync', Date.now());
                console.log('Saved to localStorage');
                
                // Broadcast changes to connected devices
                broadcastDataChange('data_updated', {
                    type: 'state_sync',
                    timestamp: Date.now(),
                    deviceId: deviceId
                });
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('pos_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    console.log('Loaded from localStorage');
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }

        // ==================== NETWORK FUNCTIONS ====================
        function generateDeviceId() {
            const id = 'POS_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
            localStorage.setItem('deviceId', id);
            return id;
        }

        function updateDeviceName() {
            const newName = document.getElementById('deviceName').value.trim();
            if (newName) {
                deviceName = newName;
                localStorage.setItem('deviceName', newName);
                logSync(`Device name updated to: ${newName}`);
                updateNetworkStatus();
            }
        }

        function detectLocalIP() {
            // Try to get local IP using WebRTC
            const RTCPeerConnection = window.RTCPeerConnection || 
                                     window.mozRTCPeerConnection || 
                                     window.webkitRTCPeerConnection;
            
            if (!RTCPeerConnection) {
                localIp = '192.168.1.x';
                updateNetworkStatus();
                return;
            }

            const pc = new RTCPeerConnection({ iceServers: [] });
            pc.createDataChannel('');
            pc.createOffer().then(pc.setLocalDescription.bind(pc));
            
            pc.onicecandidate = (ice) => {
                if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                const match = ice.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                if (match) {
                    localIp = match[1];
                    document.getElementById('localIp').textContent = localIp;
                    updateNetworkStatus();
                    logSync(`Local IP detected: ${localIp}`);
                    pc.close();
                }
            };
            
            setTimeout(() => {
                if (localIp === 'Unknown') {
                    localIp = '192.168.1.x';
                    document.getElementById('localIp').textContent = localIp;
                    updateNetworkStatus();
                }
                pc.close();
            }, 1000);
        }

        function startNetworkDiscovery() {
            // Start periodic network discovery
            broadcastInterval = setInterval(broadcastPresence, 5000);
            
            // Listen for broadcast messages
            setupBroadcastListener();
            
            logSync('Network discovery started');
        }

        function broadcastPresence() {
            const presenceData = {
                type: 'presence',
                deviceId: deviceId,
                deviceName: deviceName,
                ip: localIp,
                timestamp: Date.now(),
                isServer: isServer
            };
            
            // Broadcast to all connected peers
            broadcastToAll(presenceData);
            
            // Also add self to device list
            updateDeviceList({
                deviceId: deviceId,
                deviceName: deviceName + ' (This Device)',
                ip: localIp,
                lastSeen: Date.now(),
                status: 'connected'
            });
        }

        function setupBroadcastListener() {
            // In a real app, this would use WebSocket or WebRTC
            // For demo, we'll simulate receiving broadcasts
            setInterval(() => {
                simulateIncomingBroadcast();
            }, 3000);
        }

        function simulateIncomingBroadcast() {
            // Simulate receiving broadcasts from other devices
            const simulatedDevices = [
                {
                    deviceId: 'POS_KITCHEN',
                    deviceName: 'Kitchen Display',
                    ip: '192.168.1.' + (100 + Math.floor(Math.random() * 100)),
                    timestamp: Date.now(),
                    isServer: Math.random() > 0.7
                },
                {
                    deviceId: 'POS_TERMINAL',
                    deviceName: 'Cash Register',
                    ip: '192.168.1.' + (100 + Math.floor(Math.random() * 100)),
                    timestamp: Date.now(),
                    isServer: Math.random() > 0.7
                }
            ];
            
            // Randomly simulate receiving a broadcast
            if (Math.random() > 0.5 && !isServer) {
                const device = simulatedDevices[Math.floor(Math.random() * simulatedDevices.length)];
                handleIncomingBroadcast(device);
            }
        }

        function handleIncomingBroadcast(data) {
            if (data.deviceId === deviceId) return; // Ignore self
            
            updateDeviceList({
                deviceId: data.deviceId,
                deviceName: data.deviceName,
                ip: data.ip,
                lastSeen: Date.now(),
                status: 'available'
            });
            
            // If this device is a server, try to connect
            if (data.isServer && !isServer) {
                logSync(`Server detected: ${data.deviceName} at ${data.ip}`);
            }
        }

        function startBroadcastServer() {
            isServer = true;
            logSync('Broadcast server started');
            updateNetworkStatus('Server Running');
            
            // Start accepting connections
            startAcceptingConnections();
        }

        function startAutoDiscovery() {
            logSync('Starting auto-discovery...');
            updateNetworkStatus('Discovering...');
            
            // Simulate discovering devices
            setTimeout(() => {
                const devices = [
                    { deviceId: 'POS_1', deviceName: 'Kitchen Terminal', ip: '192.168.1.101', status: 'connected' },
                    { deviceId: 'POS_2', deviceName: 'Dining Area', ip: '192.168.1.102', status: 'available' },
                    { deviceId: 'POS_3', deviceName: 'Bar Terminal', ip: '192.168.1.103', status: 'connected' }
                ];
                
                devices.forEach(device => {
                    updateDeviceList({
                        deviceId: device.deviceId,
                        deviceName: device.deviceName,
                        ip: device.ip,
                        lastSeen: Date.now(),
                        status: device.status
                    });
                });
                
                logSync(`Discovered ${devices.length} devices`);
                updateNetworkStatus('Discovery Complete');
                
                // Auto-connect to first available device
                if (devices.length > 0 && !isServer) {
                    setTimeout(() => {
                        logSync('Auto-connecting to Kitchen Terminal...');
                        simulateConnection(devices[0]);
                    }, 1000);
                }
            }, 2000);
        }

        function simulateConnection(device) {
            // Simulate connection to a device
            updateDeviceList({
                deviceId: device.deviceId,
                deviceName: device.deviceName,
                ip: device.ip,
                lastSeen: Date.now(),
                status: 'connected'
            });
            
            connectedDevices.set(device.deviceId, device);
            
            logSync(`Connected to ${device.deviceName}`);
            updateNetworkStatus(`Connected to ${device.deviceName}`);
            
            // Request initial sync
            requestInitialSync(device.deviceId);
        }

        function startAcceptingConnections() {
            // Simulate accepting connections
            logSync('Accepting connections from other devices...');
            
            setInterval(() => {
                // Simulate new connections
                if (Math.random() > 0.7) {
                    const newDevice = {
                        deviceId: 'POS_' + Date.now().toString(36),
                        deviceName: 'New Terminal',
                        ip: '192.168.1.' + (100 + Math.floor(Math.random() * 100)),
                        lastSeen: Date.now(),
                        status: 'connected'
                    };
                    
                    updateDeviceList(newDevice);
                    connectedDevices.set(newDevice.deviceId, newDevice);
                    logSync(`${newDevice.deviceName} connected`);
                    
                    // Send welcome message
                    sendChatMessageToDevice(newDevice.deviceId, `Welcome ${newDevice.deviceName}! Connected to server.`);
                    
                    // Send current state
                    sendStateToDevice(newDevice.deviceId);
                }
            }, 5000);
        }

        function requestInitialSync(deviceId) {
            const syncRequest = {
                type: 'sync_request',
                deviceId: deviceId,
                timestamp: Date.now(),
                requestId: 'initial_sync'
            };
            
            // Send sync request
            sendToDevice(deviceId, syncRequest);
            logSync(`Requesting initial sync from ${deviceId}`);
        }

        function sendStateToDevice(targetDeviceId) {
            const stateData = {
                type: 'full_state',
                deviceId: deviceId,
                data: state,
                timestamp: Date.now()
            };
            
            sendToDevice(targetDeviceId, stateData);
            logSync(`Sent full state to ${targetDeviceId}`);
        }

        // ==================== DATA SYNC FUNCTIONS ====================
        function syncAllData() {
            logSync('Syncing all data with connected devices...');
            updateNetworkStatus('Syncing...');
            
            // Sync with all connected devices
            connectedDevices.forEach((device, deviceId) => {
                sendStateToDevice(deviceId);
            });
            
            setTimeout(() => {
                updateNetworkStatus('Sync Complete');
                logSync('All data synced successfully');
            }, 1000);
        }

        function syncTablesOnly() {
            const tablesData = {
                type: 'tables_update',
                deviceId: deviceId,
                data: state.tables,
                timestamp: Date.now()
            };
            
            broadcastToAll(tablesData);
            logSync('Tables synced with all devices');
        }

        function syncMenuOnly() {
            const menuData = {
                type: 'menu_update',
                deviceId: deviceId,
                data: state.menu,
                timestamp: Date.now()
            };
            
            broadcastToAll(menuData);
            logSync('Menu synced with all devices');
        }

        function syncOrdersOnly() {
            const ordersData = {
                type: 'orders_update',
                deviceId: deviceId,
                data: state.orders,
                timestamp: Date.now()
            };
            
            broadcastToAll(ordersData);
            logSync('Orders synced with all devices');
        }

        function forceFullSync() {
            logSync('Forcing full synchronization...');
            syncAllData();
            
            // Request sync from all connected devices
            connectedDevices.forEach((device, deviceId) => {
                requestInitialSync(deviceId);
            });
        }

        function broadcastDataChange(changeType, data) {
            const changeData = {
                type: 'data_change',
                changeType: changeType,
                deviceId: deviceId,
                data: data,
                timestamp: Date.now()
            };
            
            broadcastToAll(changeData);
        }

        function broadcastToAll(data) {
            // Broadcast to all connected devices
            connectedDevices.forEach((device, deviceId) => {
                sendToDevice(deviceId, data);
            });
            
            // Also save locally
            saveToLocalStorage();
        }

        function sendToDevice(deviceId, data) {
            // In a real app, this would send via WebSocket
            // For demo, we'll simulate sending
            console.log(`Sending to ${deviceId}:`, data);
            
            // Simulate receiving on target device
            if (Math.random() > 0.1) { // 90% success rate
                setTimeout(() => {
                    simulateReceiveFromDevice(deviceId, data);
                }, 100 + Math.random() * 400);
            }
        }

        function simulateReceiveFromDevice(sourceDeviceId, data) {
            // Simulate receiving data from another device
            handleIncomingData(sourceDeviceId, data);
        }

        function handleIncomingData(sourceDeviceId, data) {
            switch (data.type) {
                case 'full_state':
                    mergeState(data.data);
                    logSync(`Received full state from ${sourceDeviceId}`);
                    break;
                    
                case 'tables_update':
                    state.tables = data.data;
                    renderTables();
                    logSync(`Tables updated from ${sourceDeviceId}`);
                    break;
                    
                case 'menu_update':
                    state.menu = data.data;
                    renderMenu();
                    logSync(`Menu updated from ${sourceDeviceId}`);
                    break;
                    
                case 'orders_update':
                    state.orders = data.data;
                    renderKitchen();
                    logSync(`Orders updated from ${sourceDeviceId}`);
                    break;
                    
                case 'sync_request':
                    // Send our state to requesting device
                    sendStateToDevice(sourceDeviceId);
                    break;
                    
                case 'data_change':
                    // Handle specific data change
                    handleDataChange(data.changeType, data.data);
                    break;
                    
                case 'chat_message':
                    receiveChatMessage(data);
                    break;
            }
            
            // Save after processing
            saveToLocalStorage();
        }

        function mergeState(remoteState) {
            // Merge tables
            remoteState.tables.forEach(remoteTable => {
                const localTable = state.tables.find(t => t.id === remoteTable.id);
                if (!localTable) {
                    state.tables.push(remoteTable);
                } else if (remoteTable.lastModified > (localTable.lastModified || 0)) {
                    Object.assign(localTable, remoteTable);
                }
            });
            
            // Merge menu
            remoteState.menu.forEach(remoteItem => {
                const localItem = state.menu.find(m => m.id === remoteItem.id);
                if (!localItem) {
                    state.menu.push(remoteItem);
                } else if (remoteItem.lastModified > (localItem.lastModified || 0)) {
                    Object.assign(localItem, remoteItem);
                }
            });
            
            // Merge orders
            remoteState.orders.forEach(remoteOrder => {
                const localOrder = state.orders.find(o => o.id === remoteOrder.id);
                if (!localOrder) {
                    state.orders.push(remoteOrder);
                } else if (remoteOrder.lastModified > (localOrder.lastModified || 0)) {
                    Object.assign(localOrder, remoteOrder);
                }
            });
            
            // Update UI
            renderTables();
            renderMenu();
            renderKitchen();
        }

        function handleDataChange(changeType, data) {
            switch (changeType) {
                case 'new_order':
                    playNotification('new_order');
                    renderKitchen();
                    break;
                    
                case 'order_status':
                    updateOrderStatus(data.orderId, data.status);
                    break;
                    
                case 'checkout':
                    updateTableStatus(data.tableId, false);
                    break;
            }
        }

        // ==================== CHAT FUNCTIONS ====================
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add to local chat
            addChatMessage(deviceName, message, true);
            
            // Send to all connected devices
            const chatData = {
                type: 'chat_message',
                deviceId: deviceId,
                deviceName: deviceName,
                message: message,
                timestamp: Date.now()
            };
            
            broadcastToAll(chatData);
            
            // Clear input
            input.value = '';
            input.focus();
        }

        function sendQuickMessage(message) {
            addChatMessage(deviceName, message, true);
            
            const chatData = {
                type: 'chat_message',
                deviceId: deviceId,
                deviceName: deviceName,
                message: message,
                timestamp: Date.now(),
                isQuick: true
            };
            
            broadcastToAll(chatData);
            
            // Play notification for urgent messages
            if (message.includes('assistance') || message.includes('delay')) {
                playNotification('urgent');
            }
        }

        function sendChatMessageToDevice(targetDeviceId, message) {
            const chatData = {
                type: 'chat_message',
                deviceId: deviceId,
                deviceName: deviceName,
                message: message,
                timestamp: Date.now()
            };
            
            sendToDevice(targetDeviceId, chatData);
        }

        function receiveChatMessage(data) {
            if (data.deviceId === deviceId) return;
            
            addChatMessage(data.deviceName, data.message, false);
            
            // Play notification sound
            playNotification('chat');
        }

        function addChatMessage(sender, message, isLocal) {
            const container = document.getElementById('chatMessages');
            
            // Remove placeholder if present
            if (container.children.length === 1 && container.children[0].tagName === 'P') {
                container.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isLocal ? 'local' : 'remote'}`;
            messageDiv.innerHTML = `
                <strong>${sender}:</strong> ${message}
                <div style="font-size: 11px; color: #666; margin-top: 3px;">
                    ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // ==================== UI FUNCTIONS ====================
        function updateNetworkStatus(status = '') {
            const networkStatus = document.getElementById('networkStatus');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const connectedCount = document.getElementById('connectedCount');
            
            let text = '';
            let statusClass = '';
            
            if (isServer) {
                text = 'Server Running';
                statusClass = 'connected';
            } else if (connectedDevices.size > 0) {
                text = `Connected (${connectedDevices.size} devices)`;
                statusClass = 'connected';
            } else {
                text = 'Disconnected';
                statusClass = '';
            }
            
            if (status) {
                text = status;
                if (status.includes('Sync')) {
                    statusClass = 'syncing';
                }
            }
            
            networkStatus.className = `network-status ${statusClass}`;
            statusText.textContent = text;
            statusDot.className = `status-dot ${statusClass === 'syncing' ? 'pulsing' : ''}`;
            
            // Update connected count
            connectedCount.textContent = connectedDevices.size;
        }

        function updateDeviceList(device) {
            const devicesList = document.getElementById('devicesList');
            const staffList = document.getElementById('staffList');
            
            // Create device element if not exists
            let deviceElement = document.getElementById(`device-${device.deviceId}`);
            
            if (!deviceElement) {
                deviceElement = document.createElement('div');
                deviceElement.id = `device-${device.deviceId}`;
                deviceElement.className = `device-item ${device.status === 'connected' ? 'connected' : ''}`;
                
                const now = new Date(device.lastSeen);
                const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                deviceElement.innerHTML = `
                    <div class="device-info">
                        <div class="device-name">${device.deviceName}</div>
                        <div class="device-ip">${device.ip} • ${timeStr}</div>
                    </div>
                    <span class="status-badge ${device.status === 'connected' ? 'connected' : ''}">
                        ${device.status === 'connected' ? 'Connected' : 'Available'}
                    </span>
                `;
                
                // Add click to connect if available
                if (device.status === 'available') {
                    deviceElement.style.cursor = 'pointer';
                    deviceElement.onclick = () => simulateConnection(device);
                }
                
                if (devicesList.children.length === 1 && devicesList.children[0].tagName === 'P') {
                    devicesList.innerHTML = '';
                }
                devicesList.appendChild(deviceElement);
                
                // Also add to staff list if not this device
                if (device.deviceId !== deviceId) {
                    if (staffList.children.length === 1 && staffList.children[0].tagName === 'P') {
                        staffList.innerHTML = '';
                    }
                    
                    const staffElement = deviceElement.cloneNode(true);
                    staffElement.onclick = null;
                    staffElement.style.cursor = 'default';
                    staffList.appendChild(staffElement);
                }
            } else {
                // Update existing device
                const badge = deviceElement.querySelector('.status-badge');
                badge.textContent = device.status === 'connected' ? 'Connected' : 'Available';
                badge.className = `status-badge ${device.status === 'connected' ? 'connected' : ''}`;
                deviceElement.className = `device-item ${device.status === 'connected' ? 'connected' : ''}`;
                
                // Update time
                const now = new Date(device.lastSeen);
                const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                deviceElement.querySelector('.device-ip').textContent = `${device.ip} • ${timeStr}`;
            }
        }

        function logSync(message) {
            const syncLog = document.getElementById('syncLog');
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timeStr}]</span> ${message}`;
            
            syncLog.appendChild(logEntry);
            syncLog.scrollTop = syncLog.scrollHeight;
            
            // Keep last 50 entries
            const entries = syncLog.querySelectorAll('.log-entry');
            if (entries.length > 50) {
                entries[0].remove();
            }
            
            console.log(`[SYNC] ${message}`);
        }

        function playNotification(type) {
            // Create notification sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch (type) {
                    case 'new_order':
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.5);
                        break;
                        
                    case 'urgent':
                        oscillator.frequency.value = 1000;
                        oscillator.type = 'square';
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.3);
                        break;
                        
                    case 'chat':
                        oscillator.frequency.value = 600;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.2);
                        break;
                }
            } catch (e) {
                console.log('Audio notification not supported');
            }
        }

        function stopAllConnections() {
            connectedDevices.clear();
            
            // Clear device lists
            document.getElementById('devicesList').innerHTML = 
                '<p style="color: #666; text-align: center; padding: 20px;">No devices connected</p>';
            document.getElementById('staffList').innerHTML = 
                '<p style="color: #666; text-align: center; padding: 20px;">No staff connected</p>';
            
            isServer = false;
            updateNetworkStatus('Disconnected');
            logSync('All connections stopped');
        }

        // ==================== POS FUNCTIONS ====================
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            document.getElementById(`nav-${section}`).classList.add('active');
        }

        function renderTables() {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = state.tables.map(t => `
                <div class="card ${t.occupied ? 'occupied' : ''}" onclick="openTable('${t.id}')">
                    <h3>${t.number}</h3>
                    <p>Capacity: ${t.capacity}</p>
                    <p>${t.occupied ? 'Occupied' : 'Available'}</p>
                    <button class="btn btn-secondary" style="margin-top: 10px; padding: 8px 16px;" 
                            onclick="event.stopPropagation(); editTable('${t.id}')">Edit</button>
                </div>
            `).join('');
        }

        function showAddTableModal() {
            editingId = null;
            document.getElementById('tableModalTitle').textContent = 'Add Table';
            document.getElementById('tableNumber').value = '';
            document.getElementById('tableCapacity').value = '';
            document.getElementById('tableModal').classList.add('active');
        }

        function editTable(id) {
            const table = state.tables.find(t => t.id === id);
            if (!table) return;
            
            editingId = id;
            document.getElementById('tableModalTitle').textContent = 'Edit Table';
            document.getElementById('tableNumber').value = table.number;
            document.getElementById('tableCapacity').value = table.capacity;
            document.getElementById('tableModal').classList.add('active');
        }

        function saveTable() {
            const number = document.getElementById('tableNumber').value.trim();
            const capacity = parseInt(document.getElementById('tableCapacity').value);
            
            if (!number || !capacity) {
                alert('Please fill all fields');
                return;
            }

            if (editingId) {
                const table = state.tables.find(t => t.id === editingId);
                table.number = number;
                table.capacity = capacity;
                table.lastModified = Date.now();
            } else {
                state.tables.push({
                    id: Date.now().toString(),
                    number,
                    capacity,
                    occupied: false,
                    lastModified: Date.now()
                });
            }

            saveToLocalStorage();
            broadcastDataChange('table_updated', { tableId: editingId || state.tables[state.tables.length-1].id });
            renderTables();
            closeModal('tableModal');
        }

        function renderMenu() {
            const list = document.getElementById('menuList');
            list.innerHTML = state.menu.map(item => `
                <div class="menu-item">
                    <div style="flex: 1;">
                        <h4 style="margin-bottom: 5px;">${item.name}</h4>
                        <p style="color: #666;">${item.category}</p>
                        <p style="font-size: 14px; margin-top: 5px;">${item.description || ''}</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-weight: bold; color: #28a745;">$${item.price.toFixed(2)}</span>
                        <button class="btn btn-secondary" style="padding: 8px 16px;" 
                                onclick="editMenuItem('${item.id}')">Edit</button>
                    </div>
                </div>
            `).join('');
        }

        function showAddMenuModal() {
            editingId = null;
            document.getElementById('menuModalTitle').textContent = 'Add Menu Item';
            document.getElementById('itemName').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemDescription').value = '';
            document.getElementById('menuModal').classList.add('active');
        }

        function editMenuItem(id) {
            const item = state.menu.find(m => m.id === id);
            if (!item) return;
            
            editingId = id;
            document.getElementById('menuModalTitle').textContent = 'Edit Menu Item';
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('menuModal').classList.add('active');
        }

        function saveMenuItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value);
            const description = document.getElementById('itemDescription').value.trim();
            
            if (!name || !category || !price) {
                alert('Please fill required fields');
                return;
            }

            if (editingId) {
                const item = state.menu.find(m => m.id === editingId);
                item.name = name;
                item.category = category;
                item.price = price;
                item.description = description;
                item.lastModified = Date.now();
            } else {
                state.menu.push({
                    id: Date.now().toString(),
                    name,
                    category,
                    price,
                    description,
                    lastModified: Date.now()
                });
            }

            saveToLocalStorage();
            broadcastDataChange('menu_updated', { itemId: editingId || state.menu[state.menu.length-1].id });
            renderMenu();
            closeModal('menuModal');
        }

        function openTable(tableId) {
            const table = state.tables.find(t => t.id === tableId);
            if (!table) return;

            state.currentTable = tableId;
            const existingOrder = state.orders.find(o => o.tableId === tableId && o.status !== 'completed');
            state.currentOrder = existingOrder ? existingOrder.items : [];

            document.getElementById('orderTableName').textContent = `Table ${table.number}`;
            
            const menuList = document.getElementById('orderMenuList');
            menuList.innerHTML = state.menu.map(item => `
                <div class="menu-item" style="margin-bottom: 10px;">
                    <div>
                        <h4 style="margin-bottom: 5px;">${item.name}</h4>
                        <span style="color: #28a745; font-weight: bold;">$${item.price.toFixed(2)}</span>
                    </div>
                    <button class="btn btn-primary" style="padding: 8px 16px;" 
                            onclick="addToOrder('${item.id}')">Add</button>
                </div>
            `).join('');

            updateOrderDisplay();
            document.getElementById('orderModal').classList.add('active');
        }

        function addToOrder(itemId) {
            const item = state.menu.find(m => m.id === itemId);
            if (!item) return;

            const existing = state.currentOrder.find(o => o.id === itemId);
            if (existing) {
                existing.quantity++;
            } else {
                state.currentOrder.push({ ...item, quantity: 1 });
            }

            updateOrderDisplay();
        }

        function removeFromOrder(itemId) {
            state.currentOrder = state.currentOrder.filter(i => i.id !== itemId);
            updateOrderDisplay();
        }

        function updateOrderDisplay() {
            const list = document.getElementById('currentOrderList');
            
            if (state.currentOrder.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No items added</p>';
            } else {
                list.innerHTML = state.currentOrder.map(item => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                        <div>
                            <strong>${item.name}</strong>
                            <span style="margin-left: 10px;">x${item.quantity}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>$${(item.price * item.quantity).toFixed(2)}</span>
                            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 14px;" 
                                    onclick="removeFromOrder('${item.id}')">Remove</button>
                        </div>
                    </div>
                `).join('');
            }

            const subtotal = state.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * (state.settings.taxRate / 100);
            const total = subtotal + tax;

            document.getElementById('orderSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('orderTax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
        }

        function placeOrder() {
            if (state.currentOrder.length === 0) {
                alert('Add items to order');
                return;
            }

            const table = state.tables.find(t => t.id === state.currentTable);
            table.occupied = true;

            const existingOrder = state.orders.find(o => o.tableId === state.currentTable && o.status !== 'completed');
            
            if (existingOrder) {
                existingOrder.items = state.currentOrder;
                existingOrder.updatedAt = new Date().toISOString();
                existingOrder.lastModified = Date.now();
            } else {
                state.orders.push({
                    id: Date.now().toString(),
                    tableId: state.currentTable,
                    tableName: table.number,
                    items: state.currentOrder,
                    status: 'new',
                    createdAt: new Date().toISOString(),
                    lastModified: Date.now()
                });
            }

            saveToLocalStorage();
            
            // Broadcast new order to all devices
            broadcastDataChange('new_order', { 
                orderId: state.orders[state.orders.length-1].id,
                tableName: table.number,
                items: state.currentOrder.length
            });
            
            renderTables();
            alert('Order placed!');
            closeModal('orderModal');
            
            // Play notification on other devices
            playNotification('new_order');
        }

        function checkout() {
            if (state.currentOrder.length === 0) {
                alert('No items to checkout');
                return;
            }

            const table = state.tables.find(t => t.id === state.currentTable);
            table.occupied = false;

            const order = state.orders.find(o => o.tableId === state.currentTable && o.status !== 'completed');
            if (order) {
                order.status = 'completed';
                order.lastModified = Date.now();
            }

            saveToLocalStorage();
            broadcastDataChange('checkout', { tableId: state.currentTable });
            renderTables();
            alert('Checkout complete!');
            closeModal('orderModal');
        }

        function renderKitchen() {
            const container = document.getElementById('kitchenOrders');
            const activeOrders = state.orders.filter(o => o.status !== 'completed');

            if (activeOrders.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No active orders</p>';
                return;
            }

            container.innerHTML = activeOrders.map(order => `
                <div class="order-card ${order.status}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e9ecef;">
                        <div>
                            <h3>Table ${order.tableName}</h3>
                            <p style="color: #666; font-size: 14px;">${new Date(order.createdAt).toLocaleTimeString()}</p>
                        </div>
                        <span class="status-badge">${order.status.toUpperCase()}</span>
                    </div>
                    <div>
                        ${order.items.map(item => `
                            <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <strong>${item.name}</strong> x${item.quantity}
                            </div>
                        `).join('')}
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" style="padding: 8px 16px;" 
                                onclick="updateOrderStatus('${order.id}', 'processing')">Processing</button>
                        <button class="btn btn-success" style="padding: 8px 16px;" 
                                onclick="updateOrderStatus('${order.id}', 'ready')">Ready</button>
                    </div>
                </div>
            `).join('');
        }

        function updateOrderStatus(orderId, status) {
            const order = state.orders.find(o => o.id === orderId);
            if (order) {
                order.status = status;
                order.lastModified = Date.now();
                saveToLocalStorage();
                
                // Broadcast status change
                broadcastDataChange('order_status', { orderId, status });
                renderKitchen();
            }
        }

        function updateTableStatus(tableId, occupied) {
            const table = state.tables.find(t => t.id === tableId);
            if (table) {
                table.occupied = occupied;
                saveToLocalStorage();
                renderTables();
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Connect to device manually
        function connectToDevice() {
            const ip = document.getElementById('serverIp').value;
            const port = document.getElementById('serverPort').value;
            
            if (!ip) {
                alert('Please enter server IP address');
                return;
            }
            
            logSync(`Connecting to ${ip}:${port}...`);
            updateNetworkStatus('Connecting...');
            
            // Simulate connection
            setTimeout(() => {
                const device = {
                    deviceId: 'MANUAL_' + ip.replace(/\./g, '_'),
                    deviceName: 'Manual Connection',
                    ip: ip,
                    port: port,
                    lastSeen: Date.now(),
                    status: 'connected'
                };
                
                updateDeviceList(device);
                connectedDevices.set(device.deviceId, device);
                
                logSync(`Connected to ${ip}:${port}`);
                updateNetworkStatus(`Connected to ${ip}`);
                
                // Request sync
                requestInitialSync(device.deviceId);
                
                closeModal('connectionModal');
            }, 1500);
        }

        // Initialize the app
        window.onload = init;
    </script>
</body>
</html>
